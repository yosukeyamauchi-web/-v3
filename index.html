<!DOCTYPE html>
<!--
  Google Slide Generator Web Application
  
  JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰Googleã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
  
  @author ã¾ã˜ã‚“
  @version 3.0.0
  @license CC BY-NC 4.0
  @see https://creativecommons.org/licenses/by-nc/4.0/
-->
<html>
<head>
  <meta charset="utf-8">
  <title>Google Slide Generator</title>
  <base target="_top">
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
      margin: 0; padding: 0; 
      background: #ffffff;
      min-height: 100vh;
      color: #333; 
    }
    .container { 
      max-width: 1400px; 
      margin: 0 auto; 
      padding: 30px 20px; 
    }
    h1 { 
      color: #ffba00; 
      font-size: 36px; 
      font-weight: 700;
      text-align: center;
      margin-bottom: 40px;
      text-shadow: 0 2px 4px rgba(255, 186, 0, 0.3);
    }
    h2 { 
      font-size: 20px; 
      margin: 0; 
      padding: 15px 20px;
      background: linear-gradient(135deg, #ffba00, #f46524);
      color: white;
      border-radius: 8px 8px 0 0;
      font-weight: 600;
    }
    .main-grid { 
      display: grid; 
      grid-template-columns: 1.5fr 1fr; 
      gap: 30px; 
    }
    .editor-section, .settings-section { 
      background: white; 
      border-radius: 12px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid #e7edf8;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .editor-section:hover, .settings-section:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.12);
      border-color: #c2e7ff;
    }
    .editor-section { padding: 0; }
    .settings-section { padding: 0; }
    .editor-content, .settings-content { padding: 20px 25px 25px 25px; }
    #slideDataInput { 
      width: 100%; 
      height: 500px; 
      font-family: 'Fira Code', 'Consolas', monospace; 
      font-size: 14px; 
      border: 2px solid #e2e7ea; 
      border-radius: 8px; 
      padding: 15px; 
      box-sizing: border-box;
      background: #f8f9fa;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      resize: vertical;
    }
    #slideDataInput:focus {
      outline: none;
      border-color: #ffba00;
      box-shadow: 0 0 0 3px rgba(255, 186, 0, 0.1);
    }
    .settings-grid { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 20px; 
      align-items: center;
    }
    .settings-grid label { 
      font-weight: 600; 
      font-size: 14px; 
      color: #1a73e8;
      margin-bottom: 8px; 
      display: block;
    }
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 5px 0;
    }
    .checkbox-wrapper label {
      margin-bottom: 0;
      color: #333;
      font-weight: normal;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    .settings-grid input[type="text"], 
    .settings-grid select, 
    .settings-grid input[type="color"] { 
      width: 100%; 
      padding: 12px 16px; 
      border: 2px solid #e2e7ea; 
      border-radius: 8px; 
      box-sizing: border-box;
      font-size: 14px;
      transition: all 0.2s ease;
      background: #f8f9fa;
    }
    .settings-grid input[type="text"]:focus,
    .settings-grid select:focus {
      outline: none;
      border-color: #ffba00;
      box-shadow: 0 0 0 3px rgba(255, 186, 0, 0.1);
    }
    .color-picker-wrapper { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
    }
    .color-picker-wrapper input[type="color"] { 
      padding: 0; 
      height: 44px; 
      width: 60px; 
      border: 2px solid #e2e7ea; 
      border-radius: 8px;
      cursor: pointer;
      transition: border-color 0.2s ease;
    }
    .color-picker-wrapper input[type="color"]:hover {
      border-color: #ffba00;
    }
    .button-group {
      margin-top: 25px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }
    .btn {
      display: block; 
      width: 100%; 
      padding: 18px; 
      font-size: 16px; 
      font-weight: 700; 
      color: white; 
      border: none; 
      border-radius: 10px; 
      cursor: pointer; 
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .btn:disabled { 
      background: #9e9e9e; 
      cursor: not-allowed; 
      box-shadow: none;
      transform: none;
    }
    .btn:hover:not(:disabled) { 
      transform: translateY(-2px);
    }
    #generateBtn {
      background: linear-gradient(135deg, #ffba00, #f46524);
      box-shadow: 0 4px 15px rgba(255, 186, 0, 0.3);
    }
    #status { 
      margin-top: 25px; 
      padding: 20px; 
      border-radius: 10px; 
      text-align: center; 
      font-weight: 600; 
      word-wrap: break-word;
      font-size: 16px;
    }
    .status-loading { 
      background: linear-gradient(135deg, #e3f2fd, #bbdefb); 
      color: #1565c0; 
      border: 2px solid #2196f3;
    }
    .status-success { 
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9); 
      color: #2e7d32; 
      border: 2px solid #4caf50;
    }
    .status-error { 
      background: linear-gradient(135deg, #ffebee, #ffcdd2); 
      color: #c62828; 
      border: 2px solid #f44336;
    }
    .collapsible-section {
      margin: 20px 0;
      grid-column: 1 / -1;
    }
    .collapsible-header {
      background: linear-gradient(135deg, #c2e7ff, #d3e3fd);
      color: #1a73e8;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      border: 1px solid #e2e7ea;
      transition: all 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .collapsible-header:hover {
      background: linear-gradient(135deg, #b3d9ff, #c8d9fd);
    }
    .collapsible-content {
      display: none;
      padding: 20px;
      background: #f8f9fa;
      border: 1px solid #e2e7ea;
      border-top: none;
      border-radius: 0 0 8px 8px;
    }
    .collapsible-content.active {
      display: block;
    }
    .collapsible-icon {
      transition: transform 0.2s ease;
    }
    .collapsible-header.active .collapsible-icon {
      transform: rotate(180deg);
    }
    .url-input-wrapper {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .url-input-wrapper input {
      flex: 1;
    }
    .preview-btn {
      padding: 8px;
      background: #ffba00;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s ease;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      line-height: 1;
    }
    .preview-btn:hover {
      background: #f46524;
      transform: translateY(-1px);
    }
    .note-warning {
      display: none;
      margin-top: 10px;
      padding: 10px 12px;
      background: #fff8e1;
      border: 1px solid #ffecb3;
      color: #8a6d3b;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.5;
    }
    .note-info {
      margin-bottom: 15px;
      padding: 10px 12px;
      background: #e3f2fd;
      border: 1px solid #bbdefb;
      color: #1565c0;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.5;
      font-style: normal;
    }
    #gradient-options {
      display: none; /* Initially hidden */
      border-top: 1px solid #e2e7ea;
      margin-top: 20px;
      padding-top: 20px;
    }
    .preset-management {
      margin-bottom: 25px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e2e7ea;
    }
    .preset-controls label {
      display: block;
      font-weight: 600;
      margin-bottom: 10px;
      color: #333;
    }
    .preset-control-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .preset-select {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }
    .btn-preset {
      padding: 8px 16px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .btn-preset:hover {
      background: #1557b0;
      transform: translateY(-1px);
    }
    .btn-preset:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
    }
    .btn-preset-danger {
      padding: 8px 16px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .btn-preset-danger:hover {
      background: #c82333;
      transform: translateY(-1px);
    }
    .btn-preset-danger:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-1px);
    }
    .gradient-preview-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e2e7ea;
    }
    .gradient-preview-box {
      height: 60px;
      border-radius: 8px;
      background: linear-gradient(135deg, #1a73e8, #4285f4);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      margin-top: 10px;
      border: 2px solid #e2e7ea;
      transition: all 0.3s ease;
    }
    .json-validation {
      margin: 10px 0 15px 0;
      padding: 15px;
      border-radius: 8px;
      background: #f8f9fa;
      border: 1px solid #e2e7ea;
    }
    .validation-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
    }
    .validation-icon {
      font-size: 16px;
    }
    .validation-details {
      margin-top: 10px;
      font-size: 13px;
      line-height: 1.4;
      padding: 8px 12px;
      border-radius: 6px;
      display: none;
    }
    .validation-error {
      background: #ffebee;
      border: 1px solid #ffcdd2;
      color: #c62828;
    }
    .validation-warning {
      background: #fff8e1;
      border: 1px solid #ffecb3;
      color: #8a6d3b;
    }
    
    /* ãƒ•ã‚©ãƒ«ãƒ€URLè¡Œã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
    .folder-url-row input[type="text"] {
      flex: 1 1 auto;
      min-width: 0;
    }
    
    #openFolderBtn {
      flex: 0 0 auto;
    }
    
    .creator-info {
      text-align: center;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #e2e7ea;
    }
    
    .creator-info small {
      color: #6c757d;
      font-size: 12px;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Google Slide Generator</h1>
    <div class="main-grid">
      <div class="editor-section">
        <h2>1. ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›</h2>
        <div class="editor-content">
        <div id="jsonValidation" class="json-validation">
          <div class="validation-status" id="validationStatus">
            <span class="validation-icon">â³</span>
            <span class="validation-text">JSONå½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...</span>
          </div>
          <div class="validation-details" id="validationDetails"></div>
        </div>
        <textarea id="slideDataInput"></textarea>
        </div>
      </div>
      <div class="settings-section">
        <h2>2. ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š</h2>
        <div class="settings-content">
          <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç† -->
          <div class="preset-management">
            <div class="preset-controls">
              <label for="presetSelect">ä¿å­˜æ¸ˆã¿ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
              <div class="preset-control-row">
                <select id="presetSelect" class="preset-select">
                  <option value="">ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸æŠ...</option>
                </select>
                <button id="savePreset" type="button" class="btn-preset">ä¿å­˜</button>
                <button id="deletePreset" type="button" class="btn-preset-danger" disabled>å‰Šé™¤</button>
              </div>
            </div>
          </div>
          
          <div class="settings-grid">
            <div>
              <label for="primaryColor">ãƒ—ãƒ©ã‚¤ãƒãƒªã‚«ãƒ©ãƒ¼</label>
              <div class="color-picker-wrapper">
                <input type="color" id="primaryColor" value="#1a73e8">
                <input type="text" id="primaryColorText" value="#1a73e8">
              </div>
            </div>
             <div>
              <label for="fontFamily">ãƒ•ã‚©ãƒ³ãƒˆ</label>
              <select id="fontFamily">
                <option value="Noto Sans JP" selected>Noto Sans JP</option>
                <option value="Arial">Arial</option>
                <option value="M PLUS 1p">M PLUS 1p</option>
                <option value="Noto Serif JP">Noto Serif JP</option>
              </select>
            </div>
            <div style="grid-column: 1 / -1;">
              <label for="footerText">ãƒ•ãƒƒã‚¿ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ</label>
              <input type="text" id="footerText" value="">
            </div>
            <div style="grid-column: 1 / -1;">
              <label for="driveFolderUrl">ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€URL</label>
              <div class="folder-url-row" style="display: flex; gap: 6px; align-items: center;">
                <input type="text" id="driveFolderUrl" value="" style="flex: 1; margin-right: 0;">
                <button id="openFolderBtn" type="button" class="btn-secondary" style="padding: 6px 10px; font-size: 11px; white-space: nowrap; min-width: auto; flex-shrink: 0;">é–‹ã</button>
              </div>
            </div>
          </div>
          
          <div class="collapsible-section">
            <div class="collapsible-header">
              <span>è£…é£¾è¨­å®š</span>
              <span class="collapsible-icon">â–¼</span>
            </div>
            <div class="collapsible-content">
               <div class="checkbox-wrapper">
                <input type="checkbox" id="showTitleUnderline" checked>
                <label for="showTitleUnderline">ã‚¿ã‚¤ãƒˆãƒ«ä¸‹ã«ã‚¢ãƒ³ãƒ€ãƒ¼ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤º</label>
              </div>
              <div class="checkbox-wrapper">
                <input type="checkbox" id="showBottomBar" checked>
                <label for="showBottomBar">ã‚¹ãƒ©ã‚¤ãƒ‰ä¸‹éƒ¨ã«ãƒ•ãƒƒã‚¿ãƒ¼ãƒãƒ¼ã‚’è¡¨ç¤º</label>
              </div>
              <div class="checkbox-wrapper">
                <input type="checkbox" id="showDateColumn" checked>
                <label for="showDateColumn">ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ãƒ©ã‚¤ãƒ‰ã«æ—¥ä»˜ã‚’è¡¨ç¤º</label>
              </div>
              <div class="checkbox-wrapper" style="border-top: 1px solid #e2e7ea; margin-top: 15px; padding-top: 15px;">
                <input type="checkbox" id="enableGradient">
                <label for="enableGradient">ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨</label>
              </div>
              <div id="gradientWarning" class="note-warning">ç”Ÿæˆã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</div>
              <div id="gradient-options">
                <div class="settings-grid">
                   <div>
                    <label for="gradientStart">é–‹å§‹è‰²</label>
                    <div class="color-picker-wrapper">
                      <input type="color" id="gradientStart" value="#1a73e8">
                      <input type="text" id="gradientStartText" value="#1a73e8">
                    </div>
                  </div>
                  <div>
                    <label for="gradientEnd">çµ‚äº†è‰²</label>
                    <div class="color-picker-wrapper">
                      <input type="color" id="gradientEnd" value="#4285f4">
                      <input type="text" id="gradientEndText" value="#4285f4">
                    </div>
                  </div>
                </div>
                <div class="gradient-preview-section">
                  <label>ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</label>
                  <div id="gradientPreview" class="gradient-preview-box">
                    <span>ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¦‹æœ¬</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="collapsible-section">
            <div class="collapsible-header">
              <span>ãƒ­ã‚´è¨­å®š</span>
              <span class="collapsible-icon">â–¼</span>
            </div>
            <div class="collapsible-content">
              <div class="note-info">
                ç”»åƒURLã¾ãŸã¯Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®å…±æœ‰ãƒªãƒ³ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
              </div>
              <div class="settings-grid">
                <div>
                  <label for="headerLogoUrl">ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ­ã‚´</label>
                  <div class="url-input-wrapper">
                    <input type="text" id="headerLogoUrl" value="" placeholder="">
                    <button type="button" class="btn-secondary" style="padding: 6px 10px; font-size: 11px; white-space: nowrap; min-width: auto; flex-shrink: 0;">é–‹ã</button>
                  </div>
                </div>
                <div>
                  <label for="closingLogoUrl">ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ãƒ­ã‚´</label>
                  <div class="url-input-wrapper">
                    <input type="text" id="closingLogoUrl" value="" placeholder="">
                    <button type="button" class="btn-secondary" style="padding: 6px 10px; font-size: 11px; white-space: nowrap; min-width: auto; flex-shrink: 0;">é–‹ã</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="collapsible-section">
            <div class="collapsible-header">
              <span>èƒŒæ™¯è¨­å®š</span>
              <span class="collapsible-icon">â–¼</span>
            </div>
            <div class="collapsible-content">
              <div class="note-info">
                ç”»åƒURLã¾ãŸã¯Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®å…±æœ‰ãƒªãƒ³ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
              </div>
              <div class="settings-grid">
                <div>
                  <label for="titleBgUrl">ã‚¿ã‚¤ãƒˆãƒ«èƒŒæ™¯</label>
                  <div class="url-input-wrapper">
                    <input type="text" id="titleBgUrl" value="" placeholder="">
                    <button type="button" class="btn-secondary" style="padding: 6px 10px; font-size: 11px; white-space: nowrap; min-width: auto; flex-shrink: 0;">é–‹ã</button>
                  </div>
                </div>
                <div>
                  <label for="sectionBgUrl">ã‚»ã‚¯ã‚·ãƒ§ãƒ³èƒŒæ™¯</label>
                  <div class="url-input-wrapper">
                    <input type="text" id="sectionBgUrl" value="" placeholder="">
                    <button type="button" class="btn-secondary" style="padding: 6px 10px; font-size: 11px; white-space: nowrap; min-width: auto; flex-shrink: 0;">é–‹ã</button>
                  </div>
                </div>
                <div>
                  <label for="mainBgUrl">ãƒ¡ã‚¤ãƒ³èƒŒæ™¯</label>
                  <div class="url-input-wrapper">
                    <input type="text" id="mainBgUrl" value="" placeholder="">
                    <button type="button" class="btn-secondary" style="padding: 6px 10px; font-size: 11px; white-space: nowrap; min-width: auto; flex-shrink: 0;">é–‹ã</button>
                  </div>
                </div>
                <div>
                  <label for="closingBgUrl">ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°èƒŒæ™¯</label>
                  <div class="url-input-wrapper">
                    <input type="text" id="closingBgUrl" value="" placeholder="">
                    <button type="button" class="btn-secondary" style="padding: 6px 10px; font-size: 11px; white-space: nowrap; min-width: auto; flex-shrink: 0;">é–‹ã</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          


          <div class="button-group" id="buttonGroup">
             <button id="generateBtn" type="button" class="btn">ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ</button>
          </div>
          <div id="status"></div>
          
          <!-- ä½œè€…è¡¨è¨˜ -->
          <div class="creator-info">
            <small>Developed by ã¾ã˜ã‚“</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  
  <script>
    var loadedSettings = {}; // ã“ã®å€¤ã¯Google Apps Scriptç’°å¢ƒã§ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™
    
    // Google Apps Scriptç’°å¢ƒã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨˜æ³•ãŒæœ‰åŠ¹ãªå ´åˆã€ä¸Šè¨˜ã®loadedSettingsãŒç½®ãæ›ãˆã‚‰ã‚Œã‚‹
    try {
      loadedSettings = <?!= JSON.stringify(loadSettings()) ?> || {};
    } catch (e) {
      // è¨­å®šèª­ã¿è¾¼ã¿ã‚’ã‚¹ã‚­ãƒƒãƒ—
    }

  function $(id){ return document.getElementById(id); }

  function showStatus(message, type, duration){
    var s = $('status');
    if(s){
      s.textContent = message;
      s.className = 'status-' + type;
      if (duration > 0) {
        setTimeout(function() {
          if (s.textContent === message) {
            s.textContent = '';
            s.className = '';
          }
        }, duration);
      }
    }
  }

  function getCurrentSettings() {
    return {
      primaryColor: $('primaryColorText').value,
      fontFamily: $('fontFamily').value,
      showTitleUnderline: $('showTitleUnderline').checked,
      showBottomBar: $('showBottomBar').checked,
      showDateColumn: $('showDateColumn').checked,
      enableGradient: $('enableGradient').checked,
      gradientStart: $('gradientStartText').value,
      gradientEnd: $('gradientEndText').value,
      footerText: $('footerText').value.trim(),
      headerLogoUrl: $('headerLogoUrl').value.trim(),
      closingLogoUrl: $('closingLogoUrl').value.trim(),
      titleBgUrl: $('titleBgUrl').value.trim(),
      sectionBgUrl: $('sectionBgUrl').value.trim(),
      mainBgUrl: $('mainBgUrl').value.trim(),
      closingBgUrl: $('closingBgUrl').value.trim(),
      driveFolderUrl: $('driveFolderUrl').value.trim()
    };
  }


  function generate() {
    var startTime = Date.now();
    var timerId = null;
    var generateBtn = $('generateBtn');
    var slideDataString = $('slideDataInput').value;

    if (!slideDataString.trim()) {
      showStatus('ã‚¨ãƒ©ãƒ¼: ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚', 'error');
      return;
    }
    try { 
      JSON.parse(slideDataString); 
    } catch(e) {
      showStatus('ã‚¨ãƒ©ãƒ¼: JSONå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚\n' + e.message, 'error');
      return;
    }
    
    var settings = getCurrentSettings();

    function extractFolderIdFromUrl(url) {
      if (!url || !url.trim()) return '';
      var patterns = [ /\/drive\/folders\/([a-zA-Z0-9_-]+)/, /id=([a-zA-Z0-9_-]+).*folders/, /folders\/([a-zA-Z0-9_-]+)/ ];
      for (var i = 0; i < patterns.length; i++) {
        var match = url.match(patterns[i]);
        if (match && match[1]) return match[1];
      }
      return url.trim();
    }
    
    var extractedId = (function(url){
      if (!url) return '';
      // ã¾ãšãƒ•ã‚©ãƒ«ãƒ€IDã ã‘ã®å¯èƒ½æ€§
      if (/^[a-zA-Z0-9_-]{20,}$/.test(url)) return url;
      var m = url.match(/\/drive\/folders\/([a-zA-Z0-9_-]+)/) ||
              url.match(/id=([a-zA-Z0-9_-]+).*folders/) ||
              url.match(/folders\/([a-zA-Z0-9_-]+)/);
      return m ? m[1] : '';
    })(settings.driveFolderUrl);

    if (settings.driveFolderUrl && !extractedId) {
      showStatus('ã‚¨ãƒ©ãƒ¼: æ­£ã—ã„Googleãƒ‰ãƒ©ã‚¤ãƒ–ãƒ•ã‚©ãƒ«ãƒ€URLã¾ãŸã¯IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
      return;
    }
    settings.driveFolderId = extractedId;

    generateBtn.disabled = true;
    showStatus('ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™... 0ç§’', 'loading');
    // ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º
    timerId = setInterval(function(){
      var elapsed = Math.floor((Date.now() - startTime) / 1000);
      var s = $('status');
      if (s) {
        s.textContent = 'ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™... ' + elapsed + 'ç§’';
        s.className = 'status-loading';
      }
    }, 1000);

    google.script.run
      .withSuccessHandler(function(presentationUrl) {
        if (timerId) { clearInterval(timerId); timerId = null; }
        var elapsed = Math.round((Date.now() - startTime) / 1000);
        
        
        showStatus('', '');
        var statusDiv = $('status');
        statusDiv.innerHTML = 'ğŸ‰ ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼ï¼ˆ' + elapsed + 'ç§’ï¼‰<br>';
        var link = document.createElement('a');
        link.href = presentationUrl;
        link.textContent = 'ç”Ÿæˆã•ã‚ŒãŸã‚¹ãƒ©ã‚¤ãƒ‰ã‚’é–‹ã';
        link.target = '_blank';
        statusDiv.appendChild(link);
        statusDiv.className = 'status-success';
        generateBtn.disabled = false;
      })
      .withFailureHandler(function(error) {
        if (timerId) { clearInterval(timerId); timerId = null; }
        var elapsed = Math.round((Date.now() - startTime) / 1000);
        showStatus('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆ' + elapsed + 'ç§’ï¼‰: ' + error.message, 'error');
        generateBtn.disabled = false;
      })
      .generateSlidesFromWebApp(slideDataString, settings);
  }

  function toggleGradientOptions() {
    var optionsDiv = $('gradient-options');
    var warn = $('gradientWarning');
    if ($('enableGradient').checked) {
      optionsDiv.style.display = 'block';
      if (warn) warn.style.display = 'block';
    } else {
      optionsDiv.style.display = 'none';
      if (warn) warn.style.display = 'none';
    }
  }


  // è¨­å®šå€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ã™ã‚‹é–¢æ•°
  function loadSettingsToForm() {
    if (loadedSettings && typeof loadedSettings === 'object') {
      // åŸºæœ¬è¨­å®š
      if (loadedSettings.primaryColor) {
        $('primaryColor').value = loadedSettings.primaryColor;
        $('primaryColorText').value = loadedSettings.primaryColor;
      }
      if (loadedSettings.fontFamily) {
        $('fontFamily').value = loadedSettings.fontFamily;
      }
      if (loadedSettings.footerText !== undefined) {
        $('footerText').value = loadedSettings.footerText;
      }
      if (loadedSettings.driveFolderUrl !== undefined) {
        $('driveFolderUrl').value = loadedSettings.driveFolderUrl;
      }
      
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
      if (loadedSettings.showTitleUnderline !== undefined) {
        $('showTitleUnderline').checked = loadedSettings.showTitleUnderline;
      }
      if (loadedSettings.showBottomBar !== undefined) {
        $('showBottomBar').checked = loadedSettings.showBottomBar;
      }
      if (loadedSettings.showDateColumn !== undefined) {
        $('showDateColumn').checked = loadedSettings.showDateColumn;
      }
      if (loadedSettings.enableGradient !== undefined) {
        $('enableGradient').checked = loadedSettings.enableGradient;
      }
      
      // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
      if (loadedSettings.gradientStart) {
        $('gradientStart').value = loadedSettings.gradientStart;
        $('gradientStartText').value = loadedSettings.gradientStart;
      }
      if (loadedSettings.gradientEnd) {
        $('gradientEnd').value = loadedSettings.gradientEnd;
        $('gradientEndText').value = loadedSettings.gradientEnd;
      }
      
      // URLè¨­å®š
      if (loadedSettings.headerLogoUrl !== undefined) {
        $('headerLogoUrl').value = loadedSettings.headerLogoUrl;
      }
      if (loadedSettings.closingLogoUrl !== undefined) {
        $('closingLogoUrl').value = loadedSettings.closingLogoUrl;
      }
      if (loadedSettings.titleBgUrl !== undefined) {
        $('titleBgUrl').value = loadedSettings.titleBgUrl;
      }
      if (loadedSettings.sectionBgUrl !== undefined) {
        $('sectionBgUrl').value = loadedSettings.sectionBgUrl;
      }
      if (loadedSettings.mainBgUrl !== undefined) {
        $('mainBgUrl').value = loadedSettings.mainBgUrl;
      }
      if (loadedSettings.closingBgUrl !== undefined) {
        $('closingBgUrl').value = loadedSettings.closingBgUrl;
      }
      
      // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
      toggleGradientOptions();
    }
  }

  // ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†é–¢æ•°
  function getAllSettings() {
    return {
      primaryColor: $('primaryColorText').value,
      fontFamily: $('fontFamily').value,
      footerText: $('footerText').value,
      driveFolderUrl: $('driveFolderUrl').value,
      showTitleUnderline: $('showTitleUnderline').checked,
      showBottomBar: $('showBottomBar').checked,
      showDateColumn: $('showDateColumn').checked,
      enableGradient: $('enableGradient').checked,
      gradientStart: $('gradientStartText').value,
      gradientEnd: $('gradientEndText').value,
      headerLogoUrl: $('headerLogoUrl').value,
      closingLogoUrl: $('closingLogoUrl').value,
      titleBgUrl: $('titleBgUrl').value,
      sectionBgUrl: $('sectionBgUrl').value,
      mainBgUrl: $('mainBgUrl').value,
      closingBgUrl: $('closingBgUrl').value
    };
  }

  function applyAllSettings(settings) {
    $('primaryColor').value = settings.primaryColor || '#4285F4';
    $('primaryColorText').value = settings.primaryColor || '#4285F4';
    $('fontFamily').value = settings.fontFamily || 'Noto Sans JP';
    $('footerText').value = settings.footerText || '';
    $('driveFolderUrl').value = settings.driveFolderUrl || '';
    $('showTitleUnderline').checked = settings.showTitleUnderline !== false;
    $('showBottomBar').checked = settings.showBottomBar !== false;
    $('showDateColumn').checked = settings.showDateColumn !== false;
    $('enableGradient').checked = settings.enableGradient || false;
    $('gradientStart').value = settings.gradientStart || '#4285F4';
    $('gradientStartText').value = settings.gradientStart || '#4285F4';
    $('gradientEnd').value = settings.gradientEnd || '#ff52df';
    $('gradientEndText').value = settings.gradientEnd || '#ff52df';
    $('headerLogoUrl').value = settings.headerLogoUrl || '';
    $('closingLogoUrl').value = settings.closingLogoUrl || '';
    $('titleBgUrl').value = settings.titleBgUrl || '';
    $('sectionBgUrl').value = settings.sectionBgUrl || '';
    $('mainBgUrl').value = settings.mainBgUrl || '';
    $('closingBgUrl').value = settings.closingBgUrl || '';
    
    toggleGradientOptions();
    updateGradientPreview();
  }

  function loadUserPresets() {
    const presetsKey = 'slideFactory_presets';
    return JSON.parse(localStorage.getItem(presetsKey) || '{}');
  }

  function saveUserPresets(presets) {
    const presetsKey = 'slideFactory_presets';
    localStorage.setItem(presetsKey, JSON.stringify(presets));
  }

  function updatePresetSelect() {
    const presets = loadUserPresets();
    const select = $('presetSelect');
    const deleteBtn = $('deletePreset');
    
    select.innerHTML = '<option value="">ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸æŠ...</option>';
    
    Object.keys(presets).forEach(name => {
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      select.appendChild(option);
    });
    
    const hasSelection = select.value !== '';
    deleteBtn.disabled = !hasSelection;
  }

  function saveCurrentPreset() {
    const presets = loadUserPresets();
    const select = $('presetSelect');
    const selectedPreset = select.value;
    
    let name;
    let isOverwrite = false;
    
    if (selectedPreset) {
      // æ—¢å­˜ãƒ—ãƒªã‚»ãƒƒãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
      const inputName = prompt(`ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:\nï¼ˆç©ºæ¬„ã§ã€Œ${selectedPreset}ã€ã‚’ä¸Šæ›¸ãä¿å­˜ã€åå‰å…¥åŠ›ã§åˆ¥åä¿å­˜ï¼‰`);
      if (inputName === null) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      
      if (!inputName.trim()) {
        // ç©ºæ¬„ã®å ´åˆã¯ä¸Šæ›¸ãä¿å­˜
        name = selectedPreset;
        isOverwrite = true;
      } else {
        // åå‰ãŒå…¥åŠ›ã•ã‚ŒãŸå ´åˆã¯åˆ¥åä¿å­˜
        name = inputName.trim();
      }
    } else {
      // æ–°è¦ä¿å­˜ã®å ´åˆ
      name = prompt('ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!name || !name.trim()) return;
      name = name.trim();
    }
    
    if (name.length > 20) {
      alert('ãƒ—ãƒªã‚»ãƒƒãƒˆåã¯20æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    
    // æ–°è¦ä¿å­˜ã®å ´åˆã®ã¿æ•°åˆ¶é™ã‚’ãƒã‚§ãƒƒã‚¯
    const isNewPreset = !presets.hasOwnProperty(name);
    const presetCount = Object.keys(presets).length;
    
    if (isNewPreset && presetCount >= 4) {
      alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã¯æœ€å¤§4ã¤ã¾ã§ä¿å­˜ã§ãã¾ã™ã€‚æ—¢å­˜ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å‰Šé™¤ã™ã‚‹ã‹ã€ä¸Šæ›¸ãä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    
    const settings = getAllSettings();
    presets[name] = settings;
    saveUserPresets(presets);
    updatePresetSelect();
    
    select.value = name;
    
    const action = isOverwrite ? 'ä¸Šæ›¸ãä¿å­˜' : (isNewPreset ? 'ä¿å­˜' : 'åˆ¥åä¿å­˜');
    showStatus(`âœ… ãƒ—ãƒªã‚»ãƒƒãƒˆã€Œ${name}ã€ã‚’${action}ã—ã¾ã—ãŸ`, 'success', 3000);
  }

  function loadSelectedPreset() {
    const select = $('presetSelect');
    const presetName = select.value;
    
    if (!presetName) return;
    
    const presets = loadUserPresets();
    const settings = presets[presetName];
    
    if (settings) {
      applyAllSettings(settings);
      showStatus(`âœ… ãƒ—ãƒªã‚»ãƒƒãƒˆã€Œ${presetName}ã€ã‚’é©ç”¨ã—ã¾ã—ãŸ`, 'success', 3000);
    }
  }

  function deleteSelectedPreset() {
    const select = $('presetSelect');
    const presetName = select.value;
    
    if (!presetName) return;
    
    if (!confirm(`ãƒ—ãƒªã‚»ãƒƒãƒˆã€Œ${presetName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    
    const presets = loadUserPresets();
    delete presets[presetName];
    saveUserPresets(presets);
    updatePresetSelect();
    
    showStatus(`âœ… ãƒ—ãƒªã‚»ãƒƒãƒˆã€Œ${presetName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success', 3000);
  }

  function saveSelectedPresetToServer(presetName) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.status === 'success') {
        } else {
        }
      })
      .withFailureHandler(function(error) {
      })
      .saveSelectedPreset(presetName);
  }

  function restoreSelectedPreset() {
    let savedPreset = null;
    try {
      savedPreset = <?= JSON.stringify(settings?.selectedPreset ?? null) ?>;
    } catch (e) { 
    }

    if (!savedPreset || savedPreset === 'default') return;
    const select = $('presetSelect');
    if (select) {
      select.value = savedPreset;
      loadSelectedPreset();
      $('deletePreset').disabled = false;
    }
  }

  function validateJSON() {
    const textarea = $('slideDataInput');
    const statusIcon = document.querySelector('.validation-icon');
    const statusText = document.querySelector('.validation-text');
    const details = $('validationDetails');
    
    if (!textarea || !statusIcon || !statusText || !details) return;
    
    const jsonText = textarea.value.trim();
    
    if (!jsonText) {
      statusIcon.textContent = 'â³';
      statusText.textContent = 'JSONå…¥åŠ›å¾…æ©Ÿä¸­...';
      details.style.display = 'none';
      return;
    }
    
    try {
      const parsed = JSON.parse(jsonText);
      
      if (!Array.isArray(parsed)) {
        throw new Error('slideDataã¯é…åˆ—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
      }
      
      let warnings = [];
      let slideCount = 0;
      
      parsed.forEach((slide, index) => {
        if (!slide.type) {
          warnings.push(`ã‚¹ãƒ©ã‚¤ãƒ‰${index + 1}: typeãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå¿…è¦ã§ã™`);
        }
        if (slide.type === 'title' && !slide.title) {
          warnings.push(`ã‚¹ãƒ©ã‚¤ãƒ‰${index + 1}: titleã‚¹ãƒ©ã‚¤ãƒ‰ã«ã¯titleãŒå¿…è¦ã§ã™`);
        }
        slideCount++;
      });
      
      statusIcon.textContent = 'âœ…';
      statusText.textContent = `JSONå½¢å¼: æ­£å¸¸ (${slideCount}æšã®ã‚¹ãƒ©ã‚¤ãƒ‰)`;
      
      if (warnings.length > 0) {
        details.className = 'validation-details validation-warning';
        details.innerHTML = warnings.join('<br>');
        details.style.display = 'block';
      } else {
        details.style.display = 'none';
      }
      
    } catch (error) {
      statusIcon.textContent = 'âŒ';
      statusText.textContent = 'JSONå½¢å¼: ã‚¨ãƒ©ãƒ¼';
      details.className = 'validation-details validation-error';
      details.textContent = error.message;
      details.style.display = 'block';
    }
  }

  function updateGradientPreview() {
    const startColor = $('gradientStartText').value;
    const endColor = $('gradientEndText').value;
    const preview = $('gradientPreview');
    
    if (preview) {
      preview.style.background = `linear-gradient(135deg, ${startColor}, ${endColor})`;
    }
  }




  function openFolder() {
    const folderUrl = $('driveFolderUrl').value.trim();
    if (!folderUrl) {
      showStatus('ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error', 3000);
      return;
    }
    
    // URLã®å½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯
    if (!folderUrl.includes('drive.google.com') && !folderUrl.includes('docs.google.com')) {
      showStatus('æ­£ã—ã„Googleãƒ‰ãƒ©ã‚¤ãƒ–ãƒ•ã‚©ãƒ«ãƒ€URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error', 3000);
      return;
    }
    
    window.open(folderUrl, '_blank');
  }


  document.addEventListener('DOMContentLoaded', function() {
    if (!(window.google && google.script && google.script.run)) {
    }
    
    
    loadSettingsToForm();


    $('generateBtn').addEventListener('click', generate);

    $('primaryColor').addEventListener('input', function() { $('primaryColorText').value = this.value; });
    $('primaryColorText').addEventListener('input', function() { $('primaryColor').value = this.value; });
    $('gradientStart').addEventListener('input', function() { $('gradientStartText').value = this.value; updateGradientPreview(); });
    $('gradientStartText').addEventListener('input', function() { $('gradientStart').value = this.value; updateGradientPreview(); });
    $('gradientEnd').addEventListener('input', function() { $('gradientEndText').value = this.value; updateGradientPreview(); });
    $('gradientEndText').addEventListener('input', function() { $('gradientEnd').value = this.value; updateGradientPreview(); });

    $('enableGradient').addEventListener('change', toggleGradientOptions);
    toggleGradientOptions(); // Initial check
    
    $('slideDataInput').addEventListener('input', validateJSON);
    
    $('presetSelect').addEventListener('change', function() {
      const deleteBtn = $('deletePreset');
      const hasSelection = this.value !== '';
      deleteBtn.disabled = !hasSelection;
      
      // ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠæ™‚ã«è‡ªå‹•é©ç”¨
      if (hasSelection) {
        loadSelectedPreset();
        // é¸æŠã•ã‚ŒãŸãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä¿å­˜
        saveSelectedPresetToServer(this.value);
      }
    });
    
    $('savePreset').addEventListener('click', saveCurrentPreset);
    $('deletePreset').addEventListener('click', deleteSelectedPreset);
    
    $('openFolderBtn').addEventListener('click', openFolder);
    
    validateJSON();
    updateGradientPreview();
    updatePresetSelect();
    
    restoreSelectedPreset();

    document.querySelectorAll('.collapsible-header').forEach(function(header) {
      header.addEventListener('click', function() {
        var content = this.nextElementSibling;
        if (content) {
          content.classList.toggle('active');
          this.classList.toggle('active');
        }
      });
    });

    // Googleãƒ‰ãƒ©ã‚¤ãƒ–å…±æœ‰ãƒªãƒ³ã‚¯ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°ï¼ˆFileIDã¾ãŸã¯ç”»åƒURLã«å¤‰æ›ï¼‰
    function convertDriveUrl(url, extractFileIdOnly = false) {
      if (!url || !url.includes('drive.google.com')) {
        return url;
      }
      
      // ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’æŠ½å‡ºã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³
      var patterns = [
        /\/d\/([a-zA-Z0-9_-]+)/,           // https://drive.google.com/file/d/FILE_ID/view
        /id=([a-zA-Z0-9_-]+)/,            // https://drive.google.com/open?id=FILE_ID
        /\/file\/d\/([a-zA-Z0-9_-]+)/     // ã‚ˆã‚Šå…·ä½“çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³
      ];
      
      for (var i = 0; i < patterns.length; i++) {
        var match = url.match(patterns[i]);
        if (match && match[1]) {
          var fileId = match[1];
          
          // FileIDã®ã¿ã‚’è¿”ã™ã‹ã€ç”»åƒURLã«å¤‰æ›ã™ã‚‹ã‹ã‚’åˆ¤å®š
          if (extractFileIdOnly) {
            return fileId;
          } else {
            // æ—¢ã«ç”»åƒURLå½¢å¼ã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™
            if (url.includes('uc?export=view')) {
              return url;
            }
            return 'https://drive.google.com/uc?export=view&id=' + fileId;
          }
        }
      }
      
      return url; // å¤‰æ›ã§ããªã„å ´åˆã¯å…ƒã®URLã‚’è¿”ã™
    }


    function setupAutoConvertInput(input, useFileIdOnly = false) {
      input.addEventListener('input', function() {
        var url = this.value.trim();
        if (url) {
          var convertedUrl = convertDriveUrl(url, useFileIdOnly);
          if (convertedUrl !== url) {
            this.value = convertedUrl;
            var message = useFileIdOnly ? 
              'âœ… Googleãƒ‰ãƒ©ã‚¤ãƒ–å…±æœ‰ãƒªãƒ³ã‚¯ã‹ã‚‰ FileID ã‚’æŠ½å‡ºã—ã¾ã—ãŸ' : 
              'âœ… Googleãƒ‰ãƒ©ã‚¤ãƒ–å…±æœ‰ãƒªãƒ³ã‚¯ã‚’è‡ªå‹•å¤‰æ›ã—ã¾ã—ãŸ';
            showStatus(message, 'success', 1500);
          }
        }
      });
    }

    function getPreviewUrl(inputValue) {
      if (!inputValue) return null;
      
      if (inputValue.startsWith('http') && !inputValue.includes('drive.google.com')) {
        return inputValue;
      }
      
      if (inputValue.includes('drive.google.com')) {
        // æ—¢ã«å…±æœ‰ãƒªãƒ³ã‚¯ã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™
        if (inputValue.includes('/file/d/') || inputValue.includes('open?id=')) {
          return inputValue;
        }
      }
      
      var fileIdPattern = /^[a-zA-Z0-9_-]{25,}$/;
      if (fileIdPattern.test(inputValue)) {
        return 'https://drive.google.com/file/d/' + inputValue + '/view';
      }
      
      var match = inputValue.match(/[?&]id=([a-zA-Z0-9_-]+)/);
      if (match && match[1]) {
        return 'https://drive.google.com/file/d/' + match[1] + '/view';
      }
      
      return inputValue; // ãã®ä»–ã®å ´åˆã¯ãã®ã¾ã¾
    }

    document.querySelectorAll('.preview-btn, .btn-secondary').forEach(function(button) {
      // ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€URLã®ã€Œé–‹ãã€ãƒœã‚¿ãƒ³ã¯é™¤å¤–
      if (button.id === 'openFolderBtn') return;
      
      button.addEventListener('click', function() {
        var input = this.parentElement.querySelector('input[type="text"]');
        if (input) {
          var inputValue = input.value.trim();
          if (inputValue) {
            var previewUrl = getPreviewUrl(inputValue);
            if (previewUrl) {
              window.open(previewUrl, '_blank', 'noopener,noreferrer');
            } else {
              alert('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ããªã„å½¢å¼ã§ã™');
            }
          } else {
            alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          }
        }
      });
    });

    document.querySelectorAll('#titleBgUrl, #sectionBgUrl, #mainBgUrl, #closingBgUrl').forEach(function(input) {
      setupAutoConvertInput(input, true); // FileIDã®ã¿æŠ½å‡º
    });
    
    document.querySelectorAll('#headerLogoUrl, #closingLogoUrl').forEach(function(input) {
      setupAutoConvertInput(input, true); // FileIDã®ã¿æŠ½å‡º
    });
  });
</script>
</body>
</html>
